<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pomodoro Timer - Focus Mode Fixed</title>
  <style>
    :root {
      --bg: #fff;
      --text: #1f2933;
      --primary: #6c63ff;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .widget { width: 380px; background: var(--bg); border: 1px solid #000; border-radius: 16px; box-shadow: 0 14px 35px rgba(15,23,42,0.05); padding: 18px; display: flex; flex-direction: column; gap: 16px; }
    .title { font-size: 18px; font-weight: 500; color: var(--text); }
    .task-list { display: flex; flex-direction: column; gap: 6px; }
    .task { display: flex; align-items: center; justify-content: space-between; background: #fafafa; border-radius: 8px; padding: 8px 10px; border: 1px solid rgba(0,0,0,0.08); }
    .task.done span { text-decoration: line-through; color: #9ca3af; }
    .task-controls { display: flex; gap: 6px; }
    .task-btn { background: none; border: none; cursor: pointer; font-size: 14px; }
    .input { width: 100%; background: #e5e7eb; border: none; outline: none; border-radius: 10px; padding: 9px 11px; font-size: 14px; }

    /* Focus Mode */
    .focus-overlay { display: none; position: fixed; inset: 0; background: var(--primary); color: #fff; flex-direction: column; align-items: center; justify-content: center; gap: 16px; z-index: 100; }
    .focus-overlay.active { display: flex; }
    .focus-title { font-size: 20px; font-weight: 600; }
    .focus-timer { font-size: 70px; font-weight: 700; letter-spacing: .04em; }
    .focus-controls { display: flex; gap: 20px; }
    .focus-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }
    iframe { border: none; border-radius: 12px; }
    .music-player { width: 360px; height: 220px; }
  </style>
</head>
<body>
  <div class="widget">
    <div class="title">Pomodoro Timer</div>
    <div id="taskList" class="task-list"></div>
    <input id="newTask" class="input" placeholder="Add a new task" />
  </div>

  <div id="focusOverlay" class="focus-overlay">
    <div id="focusTaskTitle" class="focus-title">Time to focus!</div>
    <div id="focusTimer" class="focus-timer">25:00</div>
    <div class="focus-controls">
      <button id="focusPlay" class="focus-btn">‚ñ∂</button>
      <button id="focusPause" class="focus-btn">‚ùö‚ùö</button>
      <button id="focusExit" class="focus-btn">‚úï</button>
    </div>
    <!-- Fixed YouTube playlist embed -->
    <div id="musicContainer" style="width:360px;min-height:60px;display:flex;flex-direction:column;gap:8px;align-items:center;">
  <button id="musicBtn" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.5);border-radius:10px;padding:6px 14px;color:#fff;font-size:13px;cursor:pointer;">‚ñ∂ Play focus playlist</button>
  <!-- iframe will be injected here on click -->
</div>
  </div>

  <script>
    const newTaskEl = document.getElementById('newTask');
    const taskListEl = document.getElementById('taskList');
    const focusOverlay = document.getElementById('focusOverlay');
    const focusTaskTitle = document.getElementById('focusTaskTitle');
    const focusTimerEl = document.getElementById('focusTimer');
    const focusPlay = document.getElementById('focusPlay');
    const focusPause = document.getElementById('focusPause');
    const focusExit = document.getElementById('focusExit');
const musicBtn = document.getElementById('musicBtn');
const musicContainer = document.getElementById('musicContainer');
let isPlayerEmbedded = false;

    let tasks = [];
    let activeTaskId = null;
    let remainingSeconds = 0;
    let totalSeconds = 0;
    let timerInterval = null;

    function formatTime(sec){
      const m=Math.floor(sec/60).toString().padStart(2,'0');
      const s=(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function renderTasks(){
      taskListEl.innerHTML='';
      tasks.forEach((t)=>{
        const row=document.createElement('div');
        row.className='task'+(t.done?' done':'');
        const span=document.createElement('span');
        span.textContent=t.title;
        const ctrls=document.createElement('div');
        ctrls.className='task-controls';

        const doneBtn=document.createElement('button');
        doneBtn.className='task-btn';
        doneBtn.textContent='‚úî';
        doneBtn.onclick=(e)=>{e.stopPropagation(); toggleDone(t.id);};

        const delBtn=document.createElement('button');
        delBtn.className='task-btn';
        delBtn.textContent='üóë';
        delBtn.onclick=(e)=>{e.stopPropagation(); deleteTask(t.id);};

        const startBtn=document.createElement('button');
        startBtn.className='task-btn';
        startBtn.textContent='‚ñ∂';
        startBtn.onclick=(e)=>{e.stopPropagation(); startSession(t.id);};

        ctrls.append(doneBtn, delBtn, startBtn);
        row.append(span, ctrls);
        taskListEl.appendChild(row);
      });
    }

    function addTask(title){ tasks.push({id:crypto.randomUUID(), title, done:false}); renderTasks(); }
    function toggleDone(id){ const t=tasks.find(x=>x.id===id); if(t) t.done=!t.done; if(id===activeTaskId){ stopTimer(); exitFocus(); } renderTasks(); }
    function deleteTask(id){ tasks=tasks.filter(x=>x.id!==id); if(id===activeTaskId){ stopTimer(); exitFocus(); } renderTasks(); }

    function startSession(id){
      activeTaskId=id;
      const t=tasks.find(x=>x.id===id); if(!t) return;
      totalSeconds=remainingSeconds=25*60;
      focusTaskTitle.textContent=t.title;
      focusTimerEl.textContent=formatTime(remainingSeconds);
      focusOverlay.classList.add('active');
      // reset music state per session
      isPlayerEmbedded = false;
      if (musicContainer) musicContainer.innerHTML = `<button id="musicBtn" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.5);border-radius:10px;padding:6px 14px;color:#fff;font-size:13px;cursor:pointer;">‚ñ∂ Play focus playlist</button>`;
      // rebind btn after reset
      setTimeout(()=>{
        const btn = document.getElementById('musicBtn');
        if (btn) btn.addEventListener('click', embedPlaylist);
      },0);
    }

    function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; }
    function exitFocus(){ stopTimer(); focusOverlay.classList.remove('active'); activeTaskId=null; }

    function tick(){
      if(remainingSeconds>0){
        remainingSeconds--;
        focusTimerEl.textContent=formatTime(remainingSeconds);
      } else {
        stopTimer();
        finishSession();
      }
    }

    function finishSession(){
      const t=tasks.find(x=>x.id===activeTaskId);
      if(t) t.done=true;
      renderTasks();
      exitFocus();
      alert('Focus session complete!');
    }

    focusPlay.onclick=()=>{ if(!activeTaskId) return; stopTimer(); timerInterval=setInterval(tick,1000); };
    focusPause.onclick=()=>{ stopTimer(); };
    focusExit.onclick=()=>{ exitFocus(); };

    newTaskEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && newTaskEl.value.trim()){ addTask(newTaskEl.value.trim()); newTaskEl.value=''; }});

    renderTasks();

    function embedPlaylist(){
      if (isPlayerEmbedded) return;
      isPlayerEmbedded = true;
      const playlistID = "PLDhuj9rNT6pkbPaMSKxIcbETHyI0Ofn5X";
      const iframeSrc = `https://www.youtube.com/embed/videoseries?list=${playlistID}&autoplay=1`;
      musicContainer.innerHTML = `<iframe src="${iframeSrc}" style="width:100%;height:220px;border:0;border-radius:12px;" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
    }
    if (musicBtn) musicBtn.addEventListener('click', embedPlaylist);
  </script>
</body>
</html>
